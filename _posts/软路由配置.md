## 安装OpenWrt 

#### 1. u盘安装好Openwrt

在[http://archive.openwrt.org/](http://archive.openwrt.org/)里的release目录的/targets/x86/64/即[http://archive.openwrt.org/releases/19.07.1/targets/x86/64/](http://archive.openwrt.org/releases/19.07.1/targets/x86/64/)里下载最新版本的 "combined-ext4.img.gz"Openwrt安装文件，如：openwrt-19.07.1-x86-64-combined-ext4.img.gz

下载刻盘软件[rufus](https://rufus.ie/)，用rufus将安装映像刻录到u盘。

如果想将openwrt安装到路由器的硬盘中，一种方法是用一个**usb硬盘转接线**（如图）将路由器的硬盘接到电脑的USB接口。然后采用上述方法安装。

一种方法是用rufus制作一个ubuntu安装u盘，并将openwrt映像文件拷贝到其中，然后用linux的刻盘命令dd直接刻录到软路由中。可参考[https://teklager.se/en/knowledge-base/openwrt-installation-instructions/](https://teklager.se/en/knowledge-base/openwrt-installation-instructions/)。

**注意**：启动软路由时可以用F12(咨询商家)选择U盘启动，可用F2（咨询商家）进入Bios设置路由器第一启动的是硬盘还是u盘。

#### 2. 配置openwrt

进入Openwrt系统后，执行命令 passwd创建root的密码
```
passwd
```

#### 配置网络
```
vi /etc/config/network
```
例如，我的配置是：
```
config interface 'loopback'
        option ifname 'lo'
        option proto 'static'
        option ipaddr '127.0.0.1'
        option netmask '255.0.0.0'

config globals 'globals'
        option ula_prefix 'fdde:5bf8:b3d3::/48'

config interface 'lan'
        option type 'bridge'
        option ifname 'eth0'
        option proto 'static'
        option ipaddr '192.168.2.1'
        option netmask '255.255.255.0'
        option ip6assign '60'
        option gateway '192.168.2.1'
        option dns '192.168.2.1 8.8.8.8'

config interface 'wan'
        option ifname 'eth1'
        option proto 'pppoe'
        option ipv6 'auto'
        option username '宽带用户名'
        option password '宽带密码'
        option peerdns '0'
        option dns '192.168.2.1 8.8.8.8'

config interface 'wan6'
        option ifname 'eth1'
        option proto 'dhcpv6'
```
使修改生效
```
/etc/init.d/network reload
```


开始使用Web服务器(uHTTPd)
```python
/etc/init.d/uhttpd start
/etc/init.d/uhttpd enable
```

将软路由（Lan）和电脑用网线连接，以后可以从电脑端登录操作软路由。

####  用其他电脑登录软路由。
    
   1） 浏览器的luci访问软路由
   
   将软路由的Lan口用网线接到电脑，在电脑浏览器输入192.168.1.1，可以通过luci界面对软路由进行各种配置。如修改Lan、Wan的参数。等同于上述的软路由的命令行的操作。
   
   网络->接口->Lan，可修改软路由的ip地址。
   
   网络->接口->Wan，可设置连接外网的方式，如DHCP或静态ip或ppp2e
   
   2） 下载[winscp](https://winscp.net/eng/download.php)，以便在其他PC电脑将配置参数文件或其他文件上传到软路由。
   
   3) 用SSH登录软路由，windows系统可用SSH客户端软件[putty](https://www.putty.org/)
   
   用winscp和Putty登录软路由都需要输入软路由的ip地址、root及其密码。

卸载 dnsmasq 并安装 dnsmasq-full。安装iptable，证书等：
```python
opkg update
opkg remove dnsmasq
rm -rf /etc/config/dhcp
opkg install dnsmasq-full
opkg install iptables-mod-nat-extra ipset libopenssl

opkg install wget
opkg install ca-certificates
libustream-mbedtls libustream-mbedtls
```


vim /etc/config/network , 在wan部分修改以下三项:
```cpp
option proto 'pppoe'
option username '宽带账号'
option password '宽带密码'
```
自动检测wifi类型：

[OpenWRT 初始化配置](https://www.cnblogs.com/wizju/p/6911875.html)

```
root@OpenWrt:~# rm -f /etc/config/wireless; wifi detect > /etc/config/wireless
```

打开WiFi配置文件 vim /etc/config/wireless, 注释或者删掉 option disabled 1 这句话以启用WiFi. 在wifi-iface部分修改以下部分:
```python
config wifi-device wifi1
   option type 
   option channel 11
config wifi-iface
  option device wifi1
  #option network 'lan'
  option mode 'ap'
  option ssid 'OpenWrt'        # wifi名称
  option encryption 'psk2'     # 加密方式
  option  key 'password'       # WiFi密码
```

最后重启网络和WiFi, 路由器没必要执行重启操作:
```python
/etc/init.d/network reload
wifi
```

开始使用Web服务器(uHTTPd)
```python
/etc/init.d/uhttpd start
/etc/init.d/uhttpd enable
```

#### Openwrt 修改 LuCI 语言

System->Software->在 Filter 栏里面输入 -zh-cn 点击搜索

找到 luci-i18n-base-zh-cn 点击前面的安装。然后去设置语言即可。


[OpenWrt 常用网络配置](https://linhongbo.com/posts/openwrt-usual-configuration/)

[Openwrt 接口及基本设置](http://einverne.github.io/post/2017/03/openwrt-settings-and-tips.html)

[openWRT网络设置教程](https://roov.org/2014/10/openwrt-setup-guide/)

[使用LuCI的RPC接口修改openwrt配置](https://blog.chih.me/chang-openwtr-ppoe-password.html)

[https://www.right.com.cn/forum/thread-938058-1-1.html](https://www.right.com.cn/forum/thread-938058-1-1.html)

https://blog.csdn.net/Tree_in_sea/article/details/100590548

[OpenWrt Shadowsocks 安装&配置指南](https://linhongbo.com/posts/shadowsocks-on-openwrt/)

[openWRT网络设置教程](https://roov.org/2014/10/openwrt-setup-guide/)

[OpenWrt配置笔记](https://www.jianshu.com/p/67e94c38dab0)


### v2ray

[路由器Openwrt安装V2ray简单流程](https://github.com/felix-fly/v2ray-openwrt)

#### 上传软件及客户端配置文件

mkdir /usr/bin/v2ray
cd /usr/bin/v2ray
# 上传v2ray、config.json文件到该目录下，配置文件根据个人需求修改
chmod +x v2ray

#### 添加服务

vi /etc/config/v2ray/v2ray.servicevi

贴入以下内容保存退出：
```
#!/bin/sh /etc/rc.common
# "new(er)" style init script
# Look at /lib/functions/service.sh on a running system for explanations of what other SERVICE_
# options you can use, and when you might want them.

START=80
ROOT=/usr/bin/v2ray
SERVICE_WRITE_PID=1
SERVICE_DAEMONIZE=1

start() {
  service_start $ROOT/v2ray
}

stop() {
  service_stop $ROOT/v2ray
}
```

#### 服务自启动：
```
chmod +x /usr/bin/v2ray/v2ray.service
ln -s /usr/bin/v2ray/v2ray.service /etc/init.d/v2ray
/etc/init.d/v2ray enable

/etc/init.d/v2ray start
```
检查是否启动了v2ray:

```
ps | grep v2ray
```
输出下面信息表示已经启动

```
 2256 root      116m S    /usr/bin/v2ray/v2ray
 2274 root      3092 S    grep v2ray

```
检查软路由是否能翻墙：
```
curl -x socks5://127.0.0.1:1080 google.com
```
如果输出下面信息表示可以了：
```
<HTML><HEAD><meta http-equiv="content-type" content="text/html;charset=utf-8">
<TITLE>301 Moved</TITLE></HEAD><BODY>
<H1>301 Moved</H1>
The document has moved
<A HREF="http://www.google.com/">here</A>.
</BODY></HTML>

```


#### /usr/bin/v2ray

```
vim /etc/init.d/v2ray
```
贴入以下内容保存退出
```
#!/bin/sh /etc/rc.common
# "new(er)" style init script
# Look at /lib/functions/service.sh on a running system for explanations of what other SERVICE_
# options you can use, and when you might want them.

START=80
ROOT=/etc/config/v2ray
SERVICE_WRITE_PID=1
SERVICE_DAEMONIZE=1

start() {
  service_start $ROOT/v2ray
}

stop() {
  service_stop $ROOT/v2ray
}
```

#### 服务自启动
设置其可执行的权限:
```
chmod +x /etc/init.d/v2ray
```
为其激活开机启动:
```
/etc/init.d/v2ray enable
```
启动v2ray服务:
```
/etc/init.d/v2ray start
```
停止
```
/etc/init.d/v2ray stop
```

#### 

 检查v2ray配置文件是否正确：
```python
/usr/bin/v2ray/v2ray --test --config /etc/v2ray/config.json
/usr/bin/v2ray/v2ray --test --config /usr/bin/v2ray/config.json
```

再次检查v2ray的端口监听情况：
```
root@xxx:~# netstat -apn | grep v2ray
```

### 透明代理（可选）

开启UDP需要 iptables-mod-tproxy 模块，请确保已经安装好。即前面的安装命令：
```
opkg install ipset iptables-mod-nat-extra
```
在luci-网络-防火墙-自定义规则下添加iptables规则。也可以用开机自定义脚本（.sh后缀）实现。

规则中局域网的ip段（192.168.2.0）和v2ray监听的端口（12345）请结合实际情况修改。

```
# Only TCP
iptables -t nat -N V2RAY
iptables -t nat -A V2RAY -d 0.0.0.0 -j RETURN
iptables -t nat -A V2RAY -d 127.0.0.0 -j RETURN
iptables -t nat -A V2RAY -d 192.168.2.0/24 -j RETURN
# From lans redirect to Dokodemo-door's local port
iptables -t nat -A V2RAY -s 192.168.2.0/24 -p tcp -j REDIRECT --to-ports 12345
iptables -t nat -A PREROUTING -p tcp -j V2RAY
# With UDP support
ip rule add fwmark 1 table 100
ip route add local 0.0.0.0/0 dev lo table 100
iptables -t mangle -N V2RAY
iptables -t mangle -A V2RAY -d 0.0.0.0 -j RETURN
iptables -t mangle -A V2RAY -d 127.0.0.0 -j RETURN
iptables -t mangle -A V2RAY -d 192.168.2.0/24 -j RETURN
# From lans redirect to Dokodemo-door's local port
iptables -t mangle -A V2RAY -p tcp -s 192.168.2.0/24 -j TPROXY --on-port 12345 --tproxy-mark 1
iptables -t mangle -A V2RAY -p udp -s 192.168.2.0/24 -j TPROXY --on-port 12345 --tproxy-mark 1
iptables -t mangle -A PREROUTING -j V2RAY
```
或则
```
iptables -t nat -N V2RAY # 新建一个名为 V2RAY 的链
iptables -t nat -A V2RAY -d 192.168.0.0/16 -j RETURN # 直连 192.168.0.0/16 
iptables -t nat -A V2RAY -p tcp -j RETURN -m mark --mark 0xff # 直连 SO_MARK 为 0xff 的流量(0xff 是 16 进制数，数值上等同与上面配置的 255)，此规则目的是避免代理本机(网关)流量出现回环问题
iptables -t nat -A V2RAY -p tcp -j REDIRECT --to-ports 12345 # 其余流量转发到 12345 端口（即 V2Ray）
iptables -t nat -A PREROUTING -p tcp -j V2RAY # 对局域网其他设备进行透明代理
iptables -t nat -A OUTPUT -p tcp -j V2RAY # 对本机进行透明代理

ip rule add fwmark 1 table 100
ip route add local 0.0.0.0/0 dev lo table 100
iptables -t mangle -N V2RAY_MASK
iptables -t mangle -A V2RAY_MASK -d 192.168.0.0/16 -j RETURN
iptables -t mangle -A V2RAY_MASK -p udp -j TPROXY --on-port 12345 --tproxy-mark 1
iptables -t mangle -A PREROUTING -p udp -j V2RAY_MASK
```

[路由器Openwrt安装V2ray简单流程](https://github.com/felix-fly/v2ray-openwrt)

[网件R7800 OpenWrt使用V2Ray+mKcp+透明代理完美翻墙](https://blog.dreamtobe.cn/r7800-openwrt-v2ray/)

[1. 透明代理(TPROXY)](https://toutyrater.github.io/app/tproxy.html)

[1. 透明代理 redirect](https://toutyrater.github.io/app/transparent_proxy.html)

[https://zhuanlan.zhihu.com/p/105569599](https://zhuanlan.zhihu.com/p/105569599)



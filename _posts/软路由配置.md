### OpenWrt 

#### 1. 先用u盘安装好Openwrt

执行命令 passwd创建root的密码

#### 2. 登录luci
   
   将Lan口用网线接到电脑，在电脑浏览器输入192.168.1.1。登录
   
   网络->接口->Lan，可修改软路由的ip地址。
   
   网络->接口->Want，可设置连接外网的方式，如DHCP或静态ip或ppp2e


```python
opkg update
opkg remove dnsmasq
rm -rf /etc/config/dhcp
opkg install dnsmasq-full
opkg install ipset iptables-mod-nat-extra
```

vim /etc/config/network , 在wan部分修改以下三项:
```cpp
option proto 'pppoe'
option username '宽带账号'
option password '宽带密码'
```

打开WiFi配置文件 vim /etc/config/wireless, 注释或者删掉 option disabled 1 这句话以启用WiFi. 在wifi-iface部分修改以下部分:
```python
option ssid 'OpenWrt'        # wifi名称
option encryption 'psk2'     # 加密方式
option  key 'password'       # WiFi密码
```

最后重启网络和WiFi, 路由器没必要执行重启操作:
```python
/etc/init.d/network reload
wifi
```

开始使用Web服务器(uHTTPd)
```python
/etc/init.d/uhttpd start
/etc/init.d/uhttpd enable
```

#### Openwrt 修改 LuCI 语言

System->Software->在 Filter 栏里面输入 -zh-cn 点击搜索

找到 luci-i18n-base-zh-cn 点击前面的安装。然后去设置语言即可。


[OpenWrt 常用网络配置](https://linhongbo.com/posts/openwrt-usual-configuration/)

[Openwrt 接口及基本设置](http://einverne.github.io/post/2017/03/openwrt-settings-and-tips.html)

[openWRT网络设置教程](https://roov.org/2014/10/openwrt-setup-guide/)

[使用LuCI的RPC接口修改openwrt配置](https://blog.chih.me/chang-openwtr-ppoe-password.html)

[https://www.right.com.cn/forum/thread-938058-1-1.html](https://www.right.com.cn/forum/thread-938058-1-1.html)

https://blog.csdn.net/Tree_in_sea/article/details/100590548

[OpenWrt Shadowsocks 安装&配置指南](https://linhongbo.com/posts/shadowsocks-on-openwrt/)

[openWRT网络设置教程](https://roov.org/2014/10/openwrt-setup-guide/)

[OpenWrt配置笔记](https://www.jianshu.com/p/67e94c38dab0)


### v2ray

[路由器Openwrt安装V2ray简单流程](https://github.com/felix-fly/v2ray-openwrt)

#### 上传软件及客户端配置文件

mkdir /usr/bin/v2ray
cd /usr/bin/v2ray
# 上传v2ray、config.json文件到该目录下，配置文件根据个人需求修改
chmod +x v2ray

#### /usr/bin/v2ray

```
vim /etc/init.d/v2ray
```
贴入以下内容保存退出
```
#!/bin/sh /etc/rc.common
# "new(er)" style init script
# Look at /lib/functions/service.sh on a running system for explanations of what other SERVICE_
# options you can use, and when you might want them.

START=80
ROOT=/etc/config/v2ray
SERVICE_WRITE_PID=1
SERVICE_DAEMONIZE=1

start() {
  service_start $ROOT/v2ray
}

stop() {
  service_stop $ROOT/v2ray
}
```

#### 服务自启动
```
chmod +x /etc/init.d/v2ray
/etc/init.d/v2ray enable
```
开启
```
/etc/init.d/v2ray start
```
停止
```
/etc/init.d/v2ray start
```

### 透明代理（可选）

开启UDP需要 iptables-mod-tproxy 模块，请确保已经安装好。即前面的安装命令：
```
opkg install ipset iptables-mod-nat-extra
```
在luci-网络-防火墙-自定义规则下添加iptables规则。也可以用开机自定义脚本（.sh后缀）实现。

规则中局域网的ip段（192.168.1.0）和v2ray监听的端口（12345）请结合实际情况修改。

```
# Only TCP
iptables -t nat -N V2RAY
iptables -t nat -A V2RAY -d 0.0.0.0 -j RETURN
iptables -t nat -A V2RAY -d 127.0.0.0 -j RETURN
iptables -t nat -A V2RAY -d 192.168.1.0/24 -j RETURN
# From lans redirect to Dokodemo-door's local port
iptables -t nat -A V2RAY -s 192.168.1.0/24 -p tcp -j REDIRECT --to-ports 12345
iptables -t nat -A PREROUTING -p tcp -j V2RAY
# With UDP support
ip rule add fwmark 1 table 100
ip route add local 0.0.0.0/0 dev lo table 100
iptables -t mangle -N V2RAY
iptables -t mangle -A V2RAY -d 0.0.0.0 -j RETURN
iptables -t mangle -A V2RAY -d 127.0.0.0 -j RETURN
iptables -t mangle -A V2RAY -d 192.168.1.0/24 -j RETURN
# From lans redirect to Dokodemo-door's local port
iptables -t mangle -A V2RAY -p tcp -s 192.168.1.0/24 -j TPROXY --on-port 12345 --tproxy-mark 1
iptables -t mangle -A V2RAY -p udp -s 192.168.1.0/24 -j TPROXY --on-port 12345 --tproxy-mark 1
iptables -t mangle -A PREROUTING -j V2RAY
```
